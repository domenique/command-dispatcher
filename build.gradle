buildscript {
  ext {
    springBootVersion = '1.2.7.RELEASE'
  }
  repositories {
    mavenCentral()
    maven { url 'http://repo.spring.io/plugins-release' }
    jcenter()
  }
  dependencies {
    classpath("io.spring.gradle:dependency-management-plugin:0.5.3.RELEASE")
    classpath("org.kt3k.gradle.plugin:coveralls-gradle-plugin:2.0.1")
    classpath("org.springframework.build.gradle:propdeps-plugin:0.0.7")
    classpath("org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}")
  }
}

// some global vars to determine the type of build.
ext {
  isDevBuild = false
  isCiBuild = false
  isReleaseBuild = false
  sonatypeRepositoryUrl = null
}

allprojects {
  apply plugin: 'jacoco'
  apply plugin: 'com.github.kt3k.coveralls'

  repositories {
    mavenLocal()
    mavenCentral()
    jcenter()
  }

  jacoco {
    toolVersion = '0.7.1.201405082137'
  }
}

subprojects {
  apply plugin: 'java'
  apply plugin: 'signing'
  apply plugin: 'maven'

  sourceCompatibility = 1.8
  targetCompatibility = 1.8

  group = 'eu.tripled-framework'
  version = '0.0.1'

  //set build variables based on build type (release, continuous integration, development)
  if(project.hasProperty("release")) {
      logger.warn('This is a release build!')
      isReleaseBuild = true
      sonatypeRepositoryUrl = "https://oss.sonatype.org/service/local/staging/deploy/maven2/"
  } else if (project.hasProperty("ci")) {
      logger.warn('This is a CI build!')
      isCiBuild = true
      version += "-SNAPSHOT"
      sonatypeRepositoryUrl = "https://oss.sonatype.org/content/repositories/snapshots/"
  } else {
      logger.warn('This is a DEV build!')
      version += "-DEV"
      isDevBuild = true
  }

  task javadocJar(type: Jar) {
    classifier = 'javadoc'
    from javadoc
  }

  task sourcesJar(type: Jar) {
      classifier = 'sources'
      from sourceSets.main.allSource
  }

  artifacts {
    archives javadocJar, sourcesJar
  }

  if(isReleaseBuild || isDevBuild) {
    signing {
        sign configurations.archives
    }
  } else {
    task signArchives {
        // do nothing
    }
  }

  jacocoTestReport {
    additionalSourceDirs = files(sourceSets.main.allSource.srcDirs)
    sourceDirectories = files(sourceSets.main.allSource.srcDirs)
    classDirectories = files(sourceSets.main.output)
    reports {
      html.enabled = true
      xml.enabled = true
      csv.enabled = false
    }
  }
}

task jacocoRootReport(type: org.gradle.testing.jacoco.tasks.JacocoReport) {
  dependsOn = subprojects.test
  additionalSourceDirs = files(subprojects.sourceSets.main.allSource.srcDirs)
  sourceDirectories = files(subprojects.sourceSets.main.allSource.srcDirs)
  classDirectories = files(subprojects.sourceSets.main.output)
  executionData = files(subprojects.jacocoTestReport.executionData)
  reports {
    html.enabled = true
    xml.enabled = true
    csv.enabled = false
  }
  onlyIf = {
    true
  }
  doFirst {
    executionData = files(executionData.findAll {
      it.exists()
    })
  }
}
